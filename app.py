import os
import logging
from flask import Flask, request
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import asyncio

# --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è Render) ---
app = Flask(__name__)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
BOT_TOKEN = os.environ.get('BOT_TOKEN')
# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –≤–µ–±—Ö—É–∫–∞ (–º–æ–∂–Ω–æ –ª—é–±–æ–π)
WEBHOOK_SECRET = os.environ.get('WEBHOOK_SECRET', 'your-secret-token-for-webhook')

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
bot_application = None

# --- 2. –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç) ---
KNOWLEDGE_BASE = {
    "–ø–ª–æ—â–∞–¥—å": "üè≠ *–ï–≤—Ä–∞–∑–∏–π—Å–∫–∏–π –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ü–∞—Ä–∫ (ELP)*\n\n‚Ä¢ –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: 250 000 –∫–≤. –º\n‚Ä¢ –ö–æ—Ä–ø—É—Å –ê: 32 800 –º¬≤\n‚Ä¢ –ö–æ—Ä–ø—É—Å –í: 17 500 –º¬≤\n‚Ä¢ –ú–∏–Ω. –∞—Ä–µ–Ω–¥–∞: –æ—Ç 3 500 –º¬≤",
    "—Å—Ç–æ–∏–º–æ—Å—Ç—å": "üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã*\n\n‚Ä¢ –û—Ç 5 500 ‚Ç∏ –∑–∞ –∫–≤.–º/–º–µ—Å (—Å OPEX)\n‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —É –±—Ä–æ–∫–µ—Ä–∞",
    "—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ": "üìç *–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ*\n\n‚Ä¢ –ê–¥—Ä–µ—Å: –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª., –¢–∞–ª–≥–∞—Ä—Å–∫–∏–π —Ä-–Ω, –ö—É–ª—å–¥–∂–∏–Ω—Å–∫–∏–π —Ç—Ä–∞–∫—Ç, 200\n‚Ä¢ 30 –∫–º –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –ê–ª–º–∞—Ç—ã\n‚Ä¢ 22 –∫–º –¥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞\n‚Ä¢ 5 –∫–º –¥–æ —Ä–∞–∑–≤—è–∑–∫–∏ –ë–ê–ö–ê–î",
    "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "‚öôÔ∏è *–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–æ–≤ –∫–ª–∞—Å—Å–∞ –ê*\n\n‚Ä¢ –í—ã—Å–æ—Ç–∞: 12 –º\n‚Ä¢ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–æ–ª: 8 —Ç/–º¬≤\n‚Ä¢ –®–∞–≥ –∫–æ–ª–æ–Ω–Ω: 12√ó24 –º\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è",
    "–±—Ä–æ–∫–µ—Ä": "ü§ù *–ö–æ–Ω—Ç–∞–∫—Ç—ã*\n\n–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±—Ä–æ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞: **Bright Rich | CORFAC International**\n\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∏–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –ö–ü.",
    "—Å—Ä–æ–∫": "üìÖ *–°—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏*\n\n–ü–µ—Ä–∏–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: 2025‚Äì2028 –≥–≥.\n–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø (–ö–æ—Ä–ø—É—Å –í) –≤–≤–µ–¥—ë–Ω –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é."
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_reply_keyboard():
    keyboard = [
        ["üìê –ü–ª–æ—â–∞–¥–∏", "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å", "üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ"],
        ["‚öôÔ∏è –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏", "ü§ù –ë—Ä–æ–∫–µ—Ä", "üìÖ –°—Ä–æ–∫–∏"],
        ["üè≠ –û –ø—Ä–æ–µ–∫—Ç–µ ELP"]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)

# --- 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram ---
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = (
        "üè≠ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ü–∞—Ä–∫–∞!*\n\n"
        "–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ–± –∞—Ä–µ–Ω–¥–µ —Å–∫–ª–∞–¥–æ–≤ –∫–ª–∞—Å—Å–∞ –ê –≤ –ê–ª–º–∞—Ç—ã.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º."
    )
    await update.message.reply_text(welcome_text, 
                                   parse_mode='Markdown',
                                   reply_markup=get_reply_keyboard())

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "ü§ñ *–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É*\n\n"
        "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤\n"
        "‚Ä¢ –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ: '–ø–ª–æ—â–∞–¥—å', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', '–±—Ä–æ–∫–µ—Ä', '—Å—Ä–æ–∫'\n"
        "‚Ä¢ –°–∞–π—Ç –ø—Ä–æ–µ–∫—Ç–∞: https://elpk.kz"
    )
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_text = update.message.text.lower()
    response = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ø–ª–æ—â–∞–¥—å' –∏–ª–∏ '—Å—Ç–æ–∏–º–æ—Å—Ç—å'."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Ç–µ–∫—Å—Ç
    if any(word in user_text for word in ["–ø–ª–æ—â–∞–¥", "–º–µ—Ç—Ä"]):
        response = KNOWLEDGE_BASE["–ø–ª–æ—â–∞–¥—å"]
    elif any(word in user_text for word in ["—Å—Ç–æ–∏–º–æ—Å—Ç", "—Ü–µ–Ω", "–∞—Ä–µ–Ω–¥"]):
        response = KNOWLEDGE_BASE["—Å—Ç–æ–∏–º–æ—Å—Ç—å"]
    elif any(word in user_text for word in ["—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω", "–∞–¥—Ä–µ—Å", "–≥–¥–µ"]):
        response = KNOWLEDGE_BASE["—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ"]
    elif any(word in user_text for word in ["—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫", "—Ç–µ—Ö–Ω–∏—á"]):
        response = KNOWLEDGE_BASE["—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"]
    elif any(word in user_text for word in ["–±—Ä–æ–∫–µ—Ä", "–∫–æ–Ω—Ç–∞–∫—Ç"]):
        response = KNOWLEDGE_BASE["–±—Ä–æ–∫–µ—Ä"]
    elif any(word in user_text for word in ["—Å—Ä–æ–∫", "–∫–æ–≥–¥–∞", "—Ä–µ–∞–ª–∏–∑–∞—Ü"]):
        response = KNOWLEDGE_BASE["—Å—Ä–æ–∫"]
    elif any(word in user_text for word in ["elp", "–ø—Ä–æ–µ–∫—Ç", "–æ –ø—Ä–æ–µ–∫—Ç"]):
        response = "üè≠ *–ï–≤—Ä–∞–∑–∏–π—Å–∫–∏–π –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ü–∞—Ä–∫ (ELP)* ‚Äî –ø—Ä–æ–µ–∫—Ç —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ö–∞–±–∞ –∫–ª–∞—Å—Å–∞ –ê –ø–ª–æ—â–∞–¥—å—é 250 000 –∫–≤.–º –≤ –ê–ª–º–∞—Ç—ã. –¶–µ–ª—å ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —É–∑–ª–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–ø–æ—Ç–æ–∫–æ–≤ –≤ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏."
    
    await update.message.reply_text(response, 
                                   parse_mode='Markdown',
                                   reply_markup=get_reply_keyboard())

# --- 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (Webhook) ---
async def setup_bot():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º webhook"""
    global bot_application
    
    if not BOT_TOKEN:
        logging.error("‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
        return None
    
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞
    bot_application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    bot_application.add_handler(CommandHandler("start", start_command))
    bot_application.add_handler(CommandHandler("help", help_command))
    bot_application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    return bot_application

# --- 5. –ú–∞—Ä—à—Ä—É—Ç—ã Flask ---
@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã)"""
    return "‚úÖ –¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç ELP –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç long polling."

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)"""
    # –≠—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤–µ–±—Ö—É–∫–∏
    return "Webhook endpoint. –ë–æ—Ç —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç long polling."

# --- 6. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞"""
    bot_app = await setup_bot()
    if bot_app:
        logging.info("ü§ñ –ó–∞–ø—É—Å–∫–∞—é Telegram –±–æ—Ç–∞...")
        # –ó–ê–ü–£–°–ö–ê–ï–ú –ë–û–¢–ê –í –†–ï–ñ–ò–ú–ï LONG POLLING (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –¥–ª—è —Å—Ç–∞—Ä—Ç–∞)
        await bot_app.initialize()
        await bot_app.start()
        await bot_app.updater.start_polling()
        logging.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è
        # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!
        def run_flask():
            port = int(os.environ.get('PORT', 5000))
            app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)
        
        import threading
        flask_thread = threading.Thread(target=run_flask, daemon=True)
        flask_thread.start()
        
        # –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∂–¥—ë–º, –ø–æ–∫–∞ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        await bot_app.updater.idle()
    else:
        logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ BOT_TOKEN.")

if __name__ == '__main__':
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        level=logging.INFO
    )
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    asyncio.run(main())
